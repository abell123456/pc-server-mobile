var crypto = require('crypto'),
	https = require('https'),
	sign = require('./lib/sign');

// Cache the dynamically created certificates.
var	certificates = {};

/**
 * Create a secure context dynamically.
 * @param cn {string}
 * @param callback {Function}
 * @return {Object}
 */
function createContext(cn, callback) {
	var context = crypto.createCredentials(
			certificates[cn] || (certificates[cn] = sign(cn))
		).context;

	if (callback) { // NodeJS v0.11 ways.
		callback(null, context);
	} else { // Traditional ways.
		return context;
	}
}

/**
 * Create a HTTPS server.
 * @param listener {Function}
 * @return {Object}
 */
function createServer(listener) {
	return https.createServer({
		cert: sign.DEFAULT_CERT,
		key: sign.DEFAULT_KEY,
		SNICallback: createContext
	}, listener);
}

exports.createServer = createServer;
