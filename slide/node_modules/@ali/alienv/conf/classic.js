'use strict';

module.exports = function (config) {
    var http = require('http');
    var https = require('@ali/easy-https');
    var tianma = require('tianma');

    var appname = config.appname || '';
    var port = config.port;
    var portssl = config.portssl;
    var root = config.root || './';

    var app = tianma();

    app
        .use(function *(next) {
            yield next;
            this.response
                .head('cache-control', 'no-cache, no-store, must-revalidate')
                .head('pragma', 'no-cache');
        })
        .mount('aliunicorn.com', 'u.alicdn.com').then
            .use(require('@ali/tianma-classic-unicorn')())
            .debug()
            .static(root)
            .cache()
            .rewrite({
                'http://style.alibaba.com@42.156.172.43$1': /^(.*)$/
            })
            .end
        .mount('/').then
            .use(function *(next) {
                var res = this.response;
                yield next;
                if (res.is('otf', 'eot', 'svg', 'ttf', 'woff')) {
                    res.head('access-control-allow-origin', '*');
                }
            })
            .debug()
            .static(root)
            .cache()
            .rewrite({
                'http://style.alibaba.com@42.156.172.43$1': /^(.*)$/
            })
            .end;

    if (port) {
        http.createServer(app.run).listen(port);
        console.log('Listen to http://127.0.0.1:%s ..', port);
    }

    if (portssl) {
        https.createServer(app.run).listen(portssl);
        console.log('Listen to https://127.0.0.1:%s ..', portssl);
    }

    console.log('To stop service, press [Ctrl + C] ..');
};
