'use strict';

module.exports = function (config) {
    // Load dependencies.
    var http = require('http');
    var https = require('@ali/easy-https');
    var tianma = require('tianma');
    var routeBuild = require('../lib/route-build');
    var routeProxy = require('../lib/route-proxy');
    var unicorn = require('@ali/tianma-classic-unicorn');

    // Initiate config.
    var port = config.port;
    var portssl = config.portssl;
    var root1 = config.root1 || './htdocs';
    var root2 = config.root2 || './';
    var scope = config.system === 'bower' ?
        '' : '@alife';
    var moduledir = config.system === 'bower' ?
        'bower_components' : 'node_modules';

    // Config the pipeline.
    var app = tianma();

    app
        .use(function *(next) {
            yield next;
            this.response
                .head('cache-control', 'no-cache, no-store, must-revalidate')
                .head('pragma', 'no-cache');
        })
        .mount('aliunicorn.com', 'u.alicdn.com').then
            .use(unicorn())
            .debug()
            .static(root1)
            .cache()
            .rewrite({
                'http://style.alibaba.com@42.156.172.43$1': /^(.*)$/
            })
            .end
        .mount('alibaba.com', 'aliexpress.com', 'is.alicdn.com').then
            .use(function *(next) {
                var res = this.response;
                yield next;
                if (res.is('otf', 'eot', 'svg', 'ttf', 'woff')) {
                    res.head('access-control-allow-origin', '*');
                }
            })
            .debug()
            .static(root1)
            .cache()
            .rewrite({
                'http://style.alibaba.com@42.156.172.43$1': /^(.*)$/
            })
            .end
        .mount('i.alicdn.com').then
            .use(function *(next) {
                yield next;
                this.response
                    .head('access-control-allow-origin', '*');
            })
            .combo()
            .use(routeProxy(root2)).then
                .cache()
                .rewrite({
                    'http://i.alicdn.com@110.75.115.8$1': /^(.*)/
                })
                .end
            .rewrite({
                '$1$2$3': /^(.*)(?:\.[0-9a-f]{8})(\.\w+)(\??.*)$/,
                '$1$2': /^(.*)(?:[0-9a-f]{14}\/)(.*)$/
            })
            .use(routeBuild(root2)).then
                .static(root2)
                .end
            .end
        .mount('/').then
            .use(function *(next) {
                yield next;
                this.response
                    .head('access-control-allow-origin', '*');
            })
            .combo()
            .seaclean()
            .bundle()
            .modular({
                root: root2,
                scope: scope,
                moduledir: moduledir
            })
            .markdown({
                magic: true,
                theme: 'http://apollo.alif2e.com/assets/css/demo.css'
            })
            .debug()
            .syntaxCheck()
            .static(root2)
            .end;

    if (port) {
        http.createServer(app.run).listen(port);
        console.log('Listen to http://127.0.0.1:%s ..', port);
    }

    if (portssl) {
        https.createServer(app.run).listen(portssl);
        console.log('Listen to https://127.0.0.1:%s ..', portssl);
    }

    console.log('To stop service, press [Ctrl + C] ..');
};
