'use strict';

var fs = require('co-fs');
var path = require('path');

/**
 * Middleware factory.
 * @return {Function}
 */
module.exports = function (root) {
    return function *(next) {
    	var req = this.request;
        var res = this.response;
        var origin = req.pathname;

        var appname = origin.split('/')[1] || '';

        var pathname = path.join(
            '/',
            appname,
            '.build',
            origin
        ).replace(/\\/g, '/');

        try {
            var stats = yield fs.stat(path.join(root, pathname));

            if (stats.isFile()) {
                req.url(pathname);

                yield next;

                req.url(origin);
            } else {
                // directory 404, just like production env
                res.status(404);
            }
        } catch (err) {
            // File not found, 404.
            if (err.code === 'ENOENT') {
                res.status(404);
            } else {
                throw err;
            }
        }
    };
};
